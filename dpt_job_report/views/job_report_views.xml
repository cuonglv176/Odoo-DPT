<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Form View -->
    <record id="view_dpt_job_report_form" model="ir.ui.view">
        <field name="name">dpt.job.report.form</field>
        <field name="model">dpt.job.report</field>
        <field name="arch" type="xml">
            <form string="Báo cáo công việc">
                <header>
                    <button name="action_to_self_evaluation" string="Chuyển đến tự đánh giá" type="object" 
                            class="oe_highlight" invisible="state != 'draft'" 
                            help="Chuyển báo cáo sang trạng thái tự đánh giá khi đã hoàn thành công việc"/>
                    <button name="action_self_evaluate" string="Tự đánh giá" type="object" 
                            class="oe_highlight" invisible="state != 'self_evaluation'"
                            help="Thực hiện tự đánh giá kết quả công việc"/>
                    <button name="action_confirm" string="Xác nhận" type="object" 
                            class="oe_highlight" invisible="state not in ['draft', 'self_evaluation']"
                            help="Xác nhận báo cáo và chuyển cho quản lý đánh giá"/>
                    <button name="action_draft" string="Đặt về nháp" type="object" 
                            invisible="state not in ['self_evaluation', 'confirmed']"
                            help="Đặt báo cáo về trạng thái nháp để tiếp tục chỉnh sửa"/>
                    <button name="action_evaluate" string="Đánh giá" type="object" 
                            class="oe_highlight" invisible="state != 'confirmed'" 
                            groups="hr.group_hr_manager,hr.group_hr_user"
                            help="Đánh giá báo cáo công việc của nhân viên"/>
                    <button name="action_compute_system_tasks" string="Tính toán công việc hệ thống" type="object" 
                            class="oe_highlight" invisible="state != 'draft'"
                            help="Tự động tạo công việc hệ thống dựa trên dữ liệu nghiệp vụ"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,self_evaluation,confirmed,evaluated"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_job_tasks" type="object" class="oe_stat_button" icon="fa-tasks">
                            <field name="job_task_count" widget="statinfo" string="Công việc tự tạo"/>
                        </button>
                        <button name="action_view_system_tasks" type="object" class="oe_stat_button" icon="fa-cogs">
                            <field name="system_task_count" widget="statinfo" string="Công việc hệ thống"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="employee_id" options="{'no_create': True}"/>
                            <field name="job_id"/>
                            <field name="department_id"/>
                        </group>
                        <group>
                            <field name="date_from"/>
                            <field name="date_to"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Công việc tự tạo" name="job_tasks">
                            <field name="job_task_ids">
                                <tree editable="bottom">
                                    <field name="name"/>
                                    <field name="priority" widget="priority"/>
                                    <field name="deadline"/>
                                    <field name="source"/>
                                    <field name="assigned_by" invisible="source != 'assigned'" required="source == 'assigned'"/>
                                    <field name="state"/>
                                    <button name="action_start" string="Bắt đầu" type="object" icon="fa-play" invisible="state != 'new'"/>
                                    <button name="action_done" string="Hoàn thành" type="object" icon="fa-check" invisible="state not in ['new', 'in_progress']"/>
                                    <button name="action_cancel" string="Hủy" type="object" icon="fa-times" invisible="state in ['done', 'cancelled']"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Công việc hệ thống" name="system_tasks">
                            <field name="system_task_ids">
                                <tree>
                                    <field name="name"/>
                                    <field name="type"/>
                                    <field name="reference_name"/>
                                    <field name="state"/>
                                    <field name="date_start"/>
                                    <field name="date_end"/>
                                    <button name="action_done" string="Đánh dấu hoàn thành" type="object" icon="fa-check" invisible="state == 'done'"/>
                                    <button name="action_view_reference" string="Xem tham chiếu" type="object" icon="fa-external-link"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Hiệu suất" name="performance">
                            <group>
                                <group>
                                    <field name="completion_rate" widget="progressbar"/>
                                    <field name="avg_processing_time"/>
                                    <field name="on_time_rate" widget="progressbar"/>
                                </group>
                            </group>
                        </page>
                        <page string="Tự đánh giá" name="self_evaluation" invisible="state in ['draft']">
                            <group invisible="self_evaluation == False">
                                <field name="self_evaluation" readonly="1"/>
                                <field name="self_evaluation_date" readonly="1"/>
                            </group>
                            <group string="Góp ý/Kiến nghị" invisible="self_comment == False">
                                <field name="self_comment" readonly="1"/>
                            </group>
                            <div class="alert alert-info" role="alert" invisible="self_evaluation != False">
                                <p>Nhân viên chưa thực hiện tự đánh giá.</p>
                            </div>
                        </page>
                        <page string="Đánh giá quản lý" name="manager_evaluation" invisible="state != 'evaluated'">
                            <group>
                                <field name="manager_evaluation" readonly="1"/>
                                <field name="evaluation_user_id" readonly="1"/>
                                <field name="evaluation_date" readonly="1"/>
                            </group>
                            <group string="Nhận xét của quản lý" invisible="manager_comment == False">
                                <field name="manager_comment" readonly="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Tree View -->
    <record id="view_dpt_job_report_tree" model="ir.ui.view">
        <field name="name">dpt.job.report.tree</field>
        <field name="model">dpt.job.report</field>
        <field name="arch" type="xml">
            <tree string="Báo cáo công việc" decoration-muted="state == 'draft'" decoration-info="state == 'confirmed'" decoration-success="state == 'evaluated'" decoration-primary="state == 'self_evaluation'">
                <field name="name"/>
                <field name="employee_id"/>
                <field name="department_id"/>
                <field name="date_from"/>
                <field name="date_to"/>
                <field name="job_task_count"/>
                <field name="system_task_count"/>
                <field name="completion_rate" widget="progressbar"/>
                <field name="state"/>
            </tree>
        </field>
    </record>

    <!-- Graph View -->
    <record id="view_dpt_job_report_graph" model="ir.ui.view">
        <field name="name">dpt.job.report.graph</field>
        <field name="model">dpt.job.report</field>
        <field name="arch" type="xml">
            <graph string="Phân tích báo cáo công việc" sample="1" type="bar">
                <field name="employee_id"/>
                <field name="completion_rate" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Pivot View -->
    <record id="view_dpt_job_report_pivot" model="ir.ui.view">
        <field name="name">dpt.job.report.pivot</field>
        <field name="model">dpt.job.report</field>
        <field name="arch" type="xml">
            <pivot string="Phân tích báo cáo công việc" sample="1">
                <field name="employee_id" type="row"/>
                <field name="completion_rate" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_dpt_job_report_search" model="ir.ui.view">
        <field name="name">dpt.job.report.search</field>
        <field name="model">dpt.job.report</field>
        <field name="arch" type="xml">
            <search string="Tìm kiếm báo cáo công việc">
                <field name="name"/>
                <field name="employee_id"/>
                <field name="department_id"/>
                <field name="job_id"/>
                <filter string="Báo cáo của tôi" name="my_reports" domain="[('employee_id.user_id', '=', uid)]"/>
                <filter string="Nháp" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Tự đánh giá" name="self_evaluation" domain="[('state', '=', 'self_evaluation')]"/>
                <filter string="Đã xác nhận" name="confirmed" domain="[('state', '=', 'confirmed')]"/>
                <filter string="Đã đánh giá" name="evaluated" domain="[('state', '=', 'evaluated')]"/>
                <filter string="Tháng này" name="this_month" domain="[('date_from', '&lt;=', context_today().strftime('%Y-%m-%d')), ('date_to', '&gt;=', context_today().strftime('%Y-%m-%d'))]"/>
                <group expand="0" string="Nhóm theo">
                    <filter string="Nhân viên" name="employee" context="{'group_by': 'employee_id'}"/>
                    <filter string="Phòng ban" name="department" context="{'group_by': 'department_id'}"/>
                    <filter string="Vị trí công việc" name="job" context="{'group_by': 'job_id'}"/>
                    <filter string="Trạng thái" name="status" context="{'group_by': 'state'}"/>
                    <filter string="Tháng" name="month" context="{'group_by': 'date_from:month'}"/>
                    <filter string="Quý" name="quarter" context="{'group_by': 'date_from:quarter'}"/>
                    <filter string="Năm" name="year" context="{'group_by': 'date_from:year'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action -->
    <record id="action_dpt_job_report" model="ir.actions.act_window">
        <field name="name">Báo cáo công việc</field>
        <field name="res_model">dpt.job.report</field>
        <field name="view_mode">tree,form,graph,pivot</field>
        <field name="search_view_id" ref="view_dpt_job_report_search"/>
        <field name="context">{'search_default_my_reports': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Tạo báo cáo công việc đầu tiên của bạn!
            </p>
            <p>
                Báo cáo công việc giúp bạn theo dõi và quản lý công việc một cách hiệu quả.
            </p>
        </field>
    </record>

    <!-- Action for Job Report Analysis -->
    <record id="action_dpt_job_report_analysis" model="ir.actions.act_window">
        <field name="name">Phân tích báo cáo công việc</field>
        <field name="res_model">dpt.job.report</field>
        <field name="view_mode">graph,pivot,tree</field>
        <field name="search_view_id" ref="view_dpt_job_report_search"/>
        <field name="context">{'search_default_employee': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Không tìm thấy báo cáo công việc nào!
            </p>
            <p>
                Tạo báo cáo công việc để phân tích các chỉ số hiệu suất.
            </p>
        </field>
    </record>
</odoo> 